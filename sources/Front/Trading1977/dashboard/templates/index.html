
{% extends 'base.html' %}

{% block app_head %}

<script>

	function onError(xhr, textStatus, errorThrown) {
		errorStr = '<div style="margin-bottom: 20px;">' + xhr.status
		errorStr += ": " + errorThrown + "</div>"
		errorStr
			+= '<div style="margin-bottom: 20px;">' + textStatus + "</div>"
		errorStr += "<div>" +  xhr.responseText + "</div>"
		showServicesError(errorStr)
	}

</script>

{% endblock %}

{% block app_body %}

	<div
			style="
				margin: 15px;
				padding: 15px;
				border: black 1px solid;
				background-color: #2b2b2b;
				overflow: hidden;
				min-width: 600px;">
		<div style="float: left; font-size: 150%;">
			Interactive Brokers:
			<span id="connectionState" style="color: gray; font-weight: bold;">connection state unknown</span>
		</div>
		<div style="float: right;">
			<button id="createNewStrategy">New Strategy...</button>
			<button id="refresh">Refresh</button>
			<script>
				$("#createNewStrategy").button().button("disable")
				$("#refresh").button().button("disable").click(
					function() {
						$("#refresh").button("disable")
						theService.scheduleFullUpdate()
					})
			</script>
		</div>
	</div>

	<div id="strategies"></div>

	<table
			id="strategyTemplate"
			style="
				border: black 1px solid;
				background-color: #2b2b2b;
				margin: 15px;
				padding: 15px;
				display: none;">
		<tr>
			<td colspan="5">
				<table
						name="account"
						style="
							border: black 1px solid;
							margin: 0px;
							padding: 15px;
							text-align: right;">
					<tr>
						<td>Account: <input type="text" name="account"></td>
						<td>&nbsp;</td>
						<td>Trade: <input type="text" name="tradeNumber"></td>
					</tr>
					<tr>
						<td>Balance: <input type="text" name="balance"></td>
						<td>&nbsp;</td>
						<td>Base Currency: <input type="text" name="baseCurrency"></td>
					</tr>
				</table>
			</td>
			<td colspan="6" align="right">
				<table
						style="
							border: black 1px solid;
							margin: 0px;
							padding: 15px;
							text-align: right;">
					<tr>
						<td>Profit Target: <input type="text" name="profitTarget"></td>
						<td rowspan="2">&nbsp;</td>
						<td rowspan="2" style="vertical-align: middle; text-align: left;">Total P/L:<br><input type="text" name="totalPl"></td>
						<td rowspan="2">&nbsp;</td>
						<td>
							<button name="closeAll" style="white-space: nowrap">Close All</button><br>
						</td>
					</tr>
					<tr>
						<td>Stop Loss: <input type="text" name="stopLoss"></td>
						<td><button name="closeAll" style="white-space: nowrap">Delete</button></td>
					</tr>
				</table>
			</td>
		</tr>
		<tr><td colspan="11">&nbsp;</td></tr>
		<tr name="head">
			<td>Symbol</td>
			<td></td>
			<td>Trade Size</td>
			<td>Trade Size<br>in Base</td>
			<td>Bid</td>
			<td>Ask</td>
			<td>Spread</td>
			<td>Filled Price</td>
			<td>P/L</td>
			<td>P/L in Base</td>
			<td></td>
		</tr>
		<tr id="symbolTemplate">
			<td><input name="symbol"></td>
			<td><button name="open"></button></td>
			<td><input name="tradeSize"></td>
			<td><input name="tradeSizeInBase"></td>
			<td><input name="bid"></td>
			<td><input name="ask"></td>
			<td><input name="spread"></td>
			<td><input name="filledPrice"></td>
			<td><input name="pl"></td>
			<td><input name="plInBase"></td>
			<td><button name="close"></button></td>
		</tr>
	</table>

	<script>

		var strategies = new function() {

			var self = this

			self.strategiesCount = 0

			this.add = function(
					uid,
					account,
					baseCurrency,
					tradeSize,
					symbol1,
					symbol2) {

				var strategy = $("#strategyTemplate").clone()
				strategy.attr("id", uid)
				strategy.find("input").each(
					function() {
						$(this)
							.addClass("ui-autocomplete-input")
							.addClass("ui-widget-content")
							.addClass("ui-corner-all")
							.prop("readonly", true)
						id = $(this).attr("id")
						if (id == "balance") {
							$(this).width(85)
						} else {
							$(this).width(65)
						}
					})
				strategy.find("button").each(
					function() {
						$(this).button()
						if ($(this).attr("name") != "closeAll") {
							$(this).width(60)
						} else {
							$(this)
								.width(100)
								.addClass("sell")
								.button("disable")
						}
					})
				strategy.find("tr[name='head']").find("td").each(
					function() {
						$(this).css(
							{textAlign: "center",
							verticalAlign: "bottom"})
					})

				var strategySymbol1 = strategy.find("#symbolTemplate")
				strategySymbol1.attr("id", "")
				strategySymbol1
					.find("[name='close']")
					.addClass("sell")
					.button("disable")
					.html("Close")

				var strategySymbol2 = strategySymbol1.clone()
				strategySymbol1.after(strategySymbol2)

				strategySymbol1
					.find("[name='open']")
					.addClass("buy")
					.html("Buy")
				strategySymbol2
					.find("[name='open']")
					.addClass("sell")
					.html("Sell")

				strategySymbol1.find("[name='symbol']").val(symbol1)
				strategySymbol2.find("[name='symbol']").val(symbol2)

				strategy.find("[name='account']").val(account)
				strategy.find("[name='tradeNumber']")
					.val(self.strategiesCount + 1)
				strategy.find("[name='baseCurrency']").val(baseCurrency)

				$("#strategies").append(strategy)
				++self.strategiesCount
				strategy.show()

			}

			this.clear = function() {
				$("#strategies").html("")
				self.strategiesCount = 0
			}

		}

		var theService = new function() {

			var self = this

			this.start = function() {
				self._requestStateUpdate()
			}

			this.scheduleFullUpdate = function() {
				self._isFullUpdateRequired = true
			}

			this._onStateUpdate = function(data) {
				if ('fullUpdate' in data && data.fullUpdate) {
					strategies.clear()
				}
				if ('connection' in data) {
					self._onConnectionStateUpdate(data.connection)
				}
				if ('strategies' in data) {
					if ('new' in data.strategies) {
						data.strategies.new.forEach(self._onNewStrategy)
					}
					if ('update' in data.strategies) {
						data.strategies.update.forEach(self._onStrategyUpdate)
					}
				}
				if ('fullUpdate' in data && data.fullUpdate) {
					$("#refresh").button().button("enable")
					self._isFullUpdateRequired = false
				}
			}

			this._requestStateUpdate = function() {
				var request = {
					type: "POST",
					url: "services/getState",
					data: {csrfmiddlewaretoken: getCsrfToken()},
					success: self._onStateUpdate,
					error: onError,
					complete:
						function() {
							setTimeout(self._requestStateUpdate, 2000)
						}}
				if (self._isFullUpdateRequired) {
					request.data.fullUpdate = true
				}
				$.ajax(request)
			}

			this._onConnectionStateUpdate = function(isConnected) {
				$("#connectionState")
					.css({color: connectionState ? "green" : "red"})
					.html(isConnected ? "connected" : "disconnected")
			}

			this._onNewStrategy = function(newStrategyInfo) {
				strategies.add(
					newStrategyInfo.uid,
					newStrategyInfo.account,
					newStrategyInfo.baseCurrency,
					newStrategyInfo.tradeSize,
					newStrategyInfo.symbol1,
					newStrategyInfo.symbol2)
			}

			this._onStrategyUpdate = function(strategyInfo) {
				//...//
			}

			self._isFullUpdateRequired = true

		}

		theService.start()

	</script>

{% endblock %}
